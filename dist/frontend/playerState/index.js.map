{"version":3,"sources":["../../../src/frontend/playerState/index.ts"],"names":["PlayerState","window","params","qs","parse","location","search","ignoreQueryPrefix","href","includes","context","receiptType","presentationStyle","hasFocus","hash","callback","execCallbackOnMessage","isRemixing","editorAttributes","KojiBridge","client","playerState"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;;;;;AAkEA;AACA;AACA;IACaA,W;;;;;AACX;;AAEA;;AAEA;;AAEA;AAGA,yBAAqB;AAAA;;AAAA;AACnB,8BADmB,CAGnB;AACA;;AAJmB,gGARgB,SAQhB;AAAA;AAAA,iGAJM,KAIN;AAAA,0GAF+B,YAE/B;AAKnB,QAAK,OAAOC,MAAR,KAA2B,WAA/B,EAA4C,0DALzB,CAOnB;;AACA,QAAMC,MAA+B,GAAGC,eAAGC,KAAH,CAASH,MAAM,CAACI,QAAP,CAAgBC,MAAzB,EAAiC;AAAEC,MAAAA,iBAAiB,EAAE;AAArB,KAAjC,CAAxC,CARmB,CAUnB;;;AACA,QAAIN,MAAM,CAACI,QAAP,CAAgBG,IAAhB,CAAqBC,QAArB,CAA8B,iBAA9B,CAAJ,EAAsD;AACpD,YAAKC,OAAL,GAAe,YAAf;AACD,KAFD,MAEO;AACL;AADK,4BAMDR,MANC,CAGHQ,OAHG;AAAA,UAGHA,OAHG,gCAGO,SAHP;AAAA,UAIgBC,WAJhB,GAMDT,MANC,CAIH,iBAJG;AAAA,kCAMDA,MANC,CAKHU,iBALG;AAAA,UAKHA,iBALG,sCAKiB,YALjB;AAQL,YAAKF,OAAL,GAAeA,OAAf;AACA,YAAKC,WAAL,GAAmBA,WAAnB;AACA,YAAKC,iBAAL,GAAyBA,iBAAzB;AACD,KAxBkB,CA0BnB;;;AACA,UAAKC,QAAL,GAAgB,CAACZ,MAAM,CAACI,QAAP,CAAgBS,IAAhB,CAAqBL,QAArB,CAA8B,iBAA9B,CAAjB;AA3BmB;AA4BpB;AAED;AACF;AACA;AACA;AACA;AACA;;;;;4BAEiBM,Q,EAAmC;AAChD,WAAKF,QAAL,GAAgB,IAAhB;AAEA,aAAO,KAAKG,qBAAL,CAA2B,YAAM;AACtCD,QAAAA,QAAQ;AACT,OAFM,EAEJ,eAFI,CAAP;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;;;;2BAEgBA,Q,EAAkC;AAC9C,WAAKF,QAAL,GAAgB,KAAhB;AAEA,aAAO,KAAKG,qBAAL,CAA2B,YAAM;AACtCD,QAAAA,QAAQ;AACT,OAFM,EAEJ,gBAFI,CAAP;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;8BAEmBA,Q,EAAwC;AACvD,aAAO,KAAKC,qBAAL,CAA2B,gBAAmG;AAAA,YAAhGC,UAAgG,QAAhGA,UAAgG;AAAA,YAApFC,gBAAoF,QAApFA,gBAAoF;AACnIH,QAAAA,QAAQ,CAACE,UAAD,EAAaC,gBAAb,CAAR;AACD,OAFM,EAEJ,wBAFI,CAAP;AAGD;;;EAvF8BC,sB,qFA8C9BC,c,4JAeAA,c,8JAqBAA,c;;AAQI,IAAMC,WAAW,GAAG,IAAIrB,WAAJ,EAApB","sourcesContent":["import qs from 'qs';\nimport { KojiBridge } from '../kojiBridge';\nimport { client } from '../@decorators/client';\n\n/**\n * Context in which the Koji is being viewed. A Koji can provide a distinct experience for each context.\n */\nexport type PlayerStateContext = 'about' | 'admin' | 'remix' | 'sticker' | 'receipt' | 'screenshot' | 'default';\n\n/**\n * Who is viewing the receipt for a transaction, either `buyer` or `seller`.\n */\nexport type PlayerStateReceiptType = 'buyer' | 'seller';\n\n/**\n * Presentation style of the Koji. Popover presentation style does not include the Koji button, and thus the Koji can use the full screen.\n */\nexport type PlayerPresentationStyle = 'fullscreen' | 'popover';\n\n/**\n *\n */\nexport interface ExpectedQueryParameters {\n  context?: PlayerStateContext;\n  'dynamic-receipt'?: PlayerStateReceiptType;\n  presentationStyle?: PlayerPresentationStyle;\n}\n\n/**\n * Type of editor, either `instant` for an instant remix or `full` for the code editor.\n */\nexport type EditorType = 'instant' | 'full';\n/**\n * Distinguishes between a `new` remix and an `edit` to the userâ€™s existing Koji.\n */\nexport type EditorMode = 'edit' | 'new';\n\n/**\n * Describes the remixer's editor.\n */\nexport interface EditorAttributes {\n  /** [[EditorType]] */\n  type?: EditorType;\n  mode?: EditorMode;\n}\n\n/**\n * Who is viewing the receipt for a transaction, either `buyer` or `seller`.\n */\nexport type ReceiptType = 'seller' | 'buyer';\n\nexport type IsRemixingCallback =\n  /**\n   * Function to handle changes in remix state. Receives the `isRemixing` and `editorAttributes` properties as inputs.\n   *\n   * @param isRemixing Indicates whether the Koji is in remixing mode.\n   * @param editorAttributes\n   */\n  (isRemixing: boolean, editorAttributes: EditorAttributes) => void;\n\nexport type BlurCallback =\n/** Called when the Koji leaves focus. */\n() => void;\n\nexport type FocusCallback =\n/** Called when the Koji enters focus. */\n() => void;\n\n/**\n * Manages the context of the Koji to enable distinct experiences for different users and views.\n */\nexport class PlayerState extends KojiBridge {\n  /** The initial context of the Koji. */\n  public context: PlayerStateContext = 'default';\n  /** The type of receipt. */\n  public receiptType?: ReceiptType;\n  /** Focus state of the Koji. */\n  public hasFocus: boolean = false;\n  /** The presentation style of the Koji */\n  public presentationStyle: PlayerPresentationStyle = 'fullscreen';\n\n  public constructor() {\n    super();\n\n    // ToDo: Make this better, as it's just a way to get around the isomorphism\n    // of this package\n    if ((typeof window as any) === 'undefined') return;\n\n    // Pull off any query parameters\n    const params: ExpectedQueryParameters = qs.parse(window.location.search, { ignoreQueryPrefix: true });\n\n    // First, look for the screenshot context\n    if (window.location.href.includes('koji-screenshot')) {\n      this.context = 'screenshot';\n    } else {\n      // Otherwise, pull the context from the query parameters\n      const {\n        context = 'default',\n        'dynamic-receipt': receiptType,\n        presentationStyle = 'fullscreen',\n      } = params;\n\n      this.context = context;\n      this.receiptType = receiptType;\n      this.presentationStyle = presentationStyle;\n    }\n\n    // Set the initial value based on the feed hash\n    this.hasFocus = !window.location.hash.includes('#koji-feed-key=');\n  }\n\n  /**\n   * Listens to when a Koji is returned to a focus state.\n   *\n   * @param   callback  Callback function.\n   * @return            Function to unsubscribe from the focus state listener.\n   */\n  @client\n  public onFocus(callback: FocusCallback): Function {\n    this.hasFocus = true;\n\n    return this.execCallbackOnMessage(() => {\n      callback();\n    }, 'KojiFeed.Play');\n  }\n\n  /**\n   * Listens to when a Koji leaves a focus state.\n   *\n   * @param   callback  Callback function.\n   * @return            Function to unsubscribe from the un-focus state listener.\n   */\n  @client\n  public onBlur(callback: BlurCallback): Function {\n    this.hasFocus = false;\n\n    return this.execCallbackOnMessage(() => {\n      callback();\n    }, 'KojiFeed.Pause');\n  }\n\n  /**\n   * Listens to changes in remix state and invokes a callback function to enable different experiences during remix, preview, or use.\n   *\n   * @param   callback\n   * @return           Function to unsubscribe from remix state listener.\n   * @example\n   * ```javascript\n   * const unsubscribe = Koji.playerState.subscribe((remixing, { type, mode }) => {\n   *  // Change Koji experience\n   * });\n   * ```\n   */\n  @client\n  public subscribe(callback: IsRemixingCallback): Function {\n    return this.execCallbackOnMessage(({ isRemixing, editorAttributes }: { isRemixing: boolean; editorAttributes: EditorAttributes }) => {\n      callback(isRemixing, editorAttributes);\n    }, 'KojiPreview.IsRemixing');\n  }\n}\n\nexport const playerState = new PlayerState();\n"],"file":"index.js"}