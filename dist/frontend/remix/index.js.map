{"version":3,"sources":["../../../src/frontend/remix/index.ts"],"names":["Remix","window","execCallbackOnMessage","hasReceivedReadyResponse","remixData","Error","isInitialized","overrides","KOJI_OVERRIDES","values","arrayMerge","dest","source","path","defaultValue","newValue","sendValues","newValues","sendMessage","kojiEventName","rawValue","sendMessageAndAwaitResponse","data","plaintextValue","encryptedValue","decryptedValue","skipUpdate","KojiBridge","client","remix"],"mappings":"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","sourcesContent":["import deepmerge from 'deepmerge';\nimport { get } from '../../utils/get';\nimport { client } from '../@decorators/client';\nimport { KojiBridge } from '../kojiBridge';\n\ndeclare global {\n  interface Window {\n    /** Enables Koji's proxy server to write customized values to the KOJI_OVERRIDES property. */\n    KOJI_OVERRIDES: any;\n    /** Private reference to the Koji Feed Key, which is saved in a URL fragment when the Koji app first loads. */\n    KOJI_FEED_KEY?: string;\n  }\n}\n\n/** Communicates changes to the customization data. */\nexport interface ValueChanged {\n  /** Path of the changed value. */\n  path: string[];\n  /** New value. */\n  newValue: any;\n  /** Previous value. */\n  savedValue: any;\n}\n\n/**\n * Manages the customization experience for your Koji app.\n */\nexport class Remix extends KojiBridge {\n  private values: any = {};\n  private isInitialized: boolean = false;\n  private hasReceivedReadyResponse: boolean = false;\n\n  constructor() {\n    super();\n\n    // After Koji.ready() is invoked, the platform will always respond with a `KojiPreview.IsRemixing`\n    // message. This allows us to use an actual response from the platform to ensure that\n    // finish and set aren't called before a ready() resolution.\n    if (typeof window !== 'undefined') {\n      this.execCallbackOnMessage(() => {\n        this.hasReceivedReadyResponse = true;\n      }, 'KojiPreview.IsRemixing');\n    }\n  }\n\n  /**\n   * Initializes the Koji app's customization data with default values.\n   *\n   * NOTE: In most cases, you do not need to call this method manually because it is automatically called when you initialize the package with `Koji.config`.\n   * Use this method only if you want to use the Remix class by itself, without any other classes in the package.\n   *\n   * @param   remixData    Object containing the default values for your Koji app.\n   *\n   * @example\n   * ```javascript\n   * import { remixData } from '../../koji.json;\n   *\n   * Koji.remix.init(remixData));\n   * ```\n   */\n  @client\n  public init(remixData: any) {\n    if (!remixData) throw new Error('Unable to find remixData');\n\n    if (this.isInitialized) {\n      throw new Error('You already initialized your configuration data. Note that Koji.config() automatically calls this method.');\n    }\n\n    this.isInitialized = true;\n\n    let overrides = {};\n    if (window.KOJI_OVERRIDES && window.KOJI_OVERRIDES.overrides) {\n      overrides = window.KOJI_OVERRIDES.overrides.remixData || {};\n    }\n\n    this.values = deepmerge(remixData, overrides, {\n      arrayMerge: (dest, source) => source,\n    });\n  }\n\n  /**\n   * Gets the customization data for the Koji app.\n   *\n   * @param   path   Array of keys to target a specific value in the object.\n   * @param   defaultValue   Value to return if no value exists at the targeted path.\n   * @return  Object containing the current customization data.\n   *\n   * @example\n   * ```javascript\n   *\n   * // Return the entire `remixData` object\n   * const values = Koji.remix.get();\n   *\n   * // Return a particular value\n   * const backgroundColor = Koji.remix.get(['colors', 'background']);\n   *\n   * // Return a particular value with a default if the value is not defined\n   * const textColor = Koji.remix.get(['colors', 'text'], '#000000');\n   * ```\n   */\n  @client\n  public get<T>(path?: string[], defaultValue?: T): any | T {\n    if (!path) return this.values;\n\n    return get(this.values, path, defaultValue);\n  }\n\n  /**\n   * Updates the specified values in the customization data.\n   *\n   * NOTE: This method updates only the values that are specified in `newValue`. If other values exist, they are not changed. To replace all customization data, use [[overwrite]].\n   *\n   * @param   newValue      Key-value pairs to update in the customization data.\n   * @return                Indicates whether the values were successfully updated.\n   *\n   * @example\n   * ```javascript\n   * await Koji.remix.set({'myColor': color});\n   * ```\n   */\n  @client\n  public set(newValue: Object): Promise<boolean> {\n    if (!this.hasReceivedReadyResponse) throw new Error('It looks like you are trying to call the `Koji.remix.set()` method before calling `Koji.ready(). This will prevent data from being stored properly.`');\n\n    this.values = deepmerge(this.values, newValue, {\n      arrayMerge: (dest, source) => source,\n    });\n    return this.sendValues();\n  }\n\n  /**\n   * Replaces all customization data with the specified object.\n   *\n   * NOTE: This method overwrites all existing values in the customization data.\n   * To update specific values only, use [[set]].\n   *\n   * @param   newValues Object containing the new customization data for the Koji app.\n   * @return            Indicates whether the customization data was successfully replaced.\n   *\n   * @example\n   * ```javascript\n   * await Koji.remix.overwrite({'myColor': color, 'myText': text});\n   * ```\n   */\n  @client\n  public overwrite(newValues: Object): Promise<boolean> {\n    this.values = newValues;\n    return this.sendValues();\n  }\n\n  /**\n   * Advances the Koji app's mode from customization to preview.\n   *\n   * @example\n   * ```html\n   * <button onClick={() => Koji.remix.finish()}>\n   *  Next\n   * </button>\n   * ```\n   */\n  @client\n  public finish() {\n    if (!this.hasReceivedReadyResponse) throw new Error('It looks like you are trying to call the `Koji.remix.finish()` method before calling `Koji.ready(). This will result in unpredictable behavior in the preview of the customized app.`');\n\n    this.sendMessage({\n      kojiEventName: 'KojiPreview.Finish',\n    });\n  }\n\n  /**\n   * Cancels the customization experience and returns to where the user was before they started customization. If the user has made changes, they are prompted to confirm the cancellation.\n   *\n   * @example\n   * ```javascript\n   * Koji.remix.cancel();\n   * ```\n   */\n  @client\n  public cancel() {\n    this.sendMessage({\n      kojiEventName: 'KojiPreview.Cancel',\n    });\n  }\n\n  /**\n   * Stores sensitive data as an encrypted value. The sensitive data can only be accessed programmatically and is not available when the Koji app is configured.\n   *\n   * @param   rawValue       Value to encrypt.\n   * @return                 Encrypted value. Use this value to [[decryptValue | decrypt the value]] on the frontend, for the creator, or to {@doclink core-backend-secret#resolveValue | resolve the value} on the backend, for other users.\n   *\n   * @example\n   * ```javascript\n   * const encryptPath = await Koji.remix.encryptValue(text);\n   * ```\n   */\n  @client\n  public async encryptValue(rawValue: any): Promise<string> {\n    const data = await this.sendMessageAndAwaitResponse(\n      {\n        kojiEventName: 'KojiPreview.EncryptValue',\n        data: {\n          plaintextValue: rawValue,\n        },\n      },\n      'KojiPreview.ValueEncrypted',\n    );\n\n    return data.encryptedValue;\n  }\n\n  /**\n   * Retrieves sensitive data that was [[encryptValue | stored as an encrypted value]].\n   *\n   * NOTE: Only the owner of the Koji app can access the decrypted value with this method. For example, to check that the value was entered correctly. To retrieve the value for other users, use {@doclink core-backend-secret#resolveValue | Secret.resolveValue} on the backend.\n   *\n   * @param   encryptedValue Path where the encrypted value is stored.\n   * @return                 Decrypted value.\n   *\n   * @example\n   * ```javascript\n   * const value = await Koji.remix.decryptValue(encryptPath);\n   * ```\n   */\n  @client\n  public async decryptValue(encryptedValue: any): Promise<string> {\n    const data = await this.sendMessageAndAwaitResponse(\n      {\n        kojiEventName: 'KojiPreview.DecryptValue',\n        data: {\n          encryptedValue,\n        },\n      },\n      'KojiPreview.ValueDecrypted',\n    );\n\n    return data.decryptedValue;\n  }\n\n  /**\n   * Sends an event to update the preview with the current customization data.\n   *\n   * @return\n   */\n  private async sendValues() {\n    const data: ValueChanged = await this.sendMessageAndAwaitResponse(\n      {\n        kojiEventName: 'KojiPreview.SetValue',\n        data: {\n          path: ['remixData'],\n          newValue: this.values,\n          skipUpdate: false,\n        },\n      },\n      'KojiPreview.DidChangeVcc',\n    );\n\n    return !!data;\n  }\n}\n\nexport const remix = new Remix();\n"],"file":"index.js"}