{"version":3,"sources":["../../../src/frontend/kojiBridge/index.ts"],"names":["KojiBridge","callback","eventName","messageListener","data","event","window","addEventListener","removeEventListener","postMessage","parent","_kojiEventName","kojiEventName","_type","_feedKey","location","hash","replace","platformMessageName","additionalPlatformMessageName","Promise","resolve","reject","idempotencyKey","_idempotencyKey","err"],"mappings":";;;;;;;;;;;;;;;AACA;;;;;;AAeA;AACA;AACA;IACaA,U;;;;;;;;AACX;AACF;AACA;AACA;AACA;AACA;AACA;0CACkCC,Q,EAAoBC,S,EAAmB;AACrE,UAAMC,eAAe,GAAG,SAAlBA,eAAkB,OAA6C;AAAA,YAA1CC,IAA0C,QAA1CA,IAA0C;AAAA,YAC3DC,KAD2D,GACjDD,IADiD,CAC3DC,KAD2D;;AAEnE,YAAIA,KAAK,KAAKH,SAAd,EAAyB;AACvBD,UAAAA,QAAQ,CAACG,IAAD,CAAR;AACD;AACF,OALD;;AAOAE,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEA,aAAO,YAAM;AACXG,QAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACD,OAFD;AAGD;AAED;AACF;AACA;AACA;;;;gCACwBM,W,EAAgC;AACpDH,MAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,QAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,QAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,QAAAA,QAAQ,EAAER,MAAM,CAACS,QAAP,CAAgBC,IAAhB,CAAqBC,OAArB,CAA6B,iBAA7B,EAAgD,EAAhD;AAJd,SAKOR,WAAW,CAACL,IALnB,GAOE,GAPF;AASD;;;gDAEqCK,W,EAA0BS,mB,EAA6BC,6B,EAAsD;AACjJ,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAMC,cAAc,GAAG,eAAvB;;AAEA,YAAMpB,eAAe,GAAG,SAAlBA,eAAkB,QAA6C;AAAA,cAA1CC,IAA0C,SAA1CA,IAA0C;;AACnE,cAAI;AAAA,gBACMC,KADN,GACiCD,IADjC,CACMC,KADN;AAAA,gBACamB,eADb,GACiCpB,IADjC,CACaoB,eADb;;AAEF,gBAAI,CAACnB,KAAK,KAAKa,mBAAV,IAAiCb,KAAK,KAAKc,6BAA5C,KAA8EI,cAAc,KAAKC,eAArG,EAAsH;AACpHlB,cAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACAkB,cAAAA,OAAO,CAACjB,IAAD,CAAP;AACD;AACF,WAND,CAME,OAAOqB,GAAP,EAAY;AACZH,YAAAA,MAAM,CAACG,GAAD,CAAN;AACD;AACF,SAVD;;AAYAnB,QAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEAG,QAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,UAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,UAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,UAAAA,QAAQ,EAAER,MAAM,CAACS,QAAP,CAAgBC,IAAhB,CAAqBC,OAArB,CAA6B,iBAA7B,EAAgD,EAAhD,CAJd;AAKIO,UAAAA,eAAe,EAAED;AALrB,WAMOd,WAAW,CAACL,IANnB,GAQE,GARF;AAUD,OA3BM,CAAP;AA4BD","sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\nimport { v4 as uuidv4 } from 'uuid';\n\ninterface MessageListenerData {\n  /** Name of the event. */\n  event: string;\n  /** Unique key to prevent duplicate processing. */\n  _idempotencyKey?: string;\n}\n\ninterface PostMessage {\n  /** Name of the event. */\n  kojiEventName: string;\n  /** Data to send with event. */\n  data?: any;\n}\n/**\n * Enables communication between the platform and the Koji.\n */\nexport class KojiBridge {\n  /**\n   * Sets a listener for a specific event, and invokes a function to handle the event.\n   *\n   * @param   callback  Function to run when the event is fired.\n   * @param   eventName Name of the event.\n   * @return            [description]\n   */\n  protected execCallbackOnMessage(callback: Function, eventName: string) {\n    const messageListener = ({ data }: { data: MessageListenerData }) => {\n      const { event } = data;\n      if (event === eventName) {\n        callback(data);\n      }\n    };\n\n    window.addEventListener('message', messageListener);\n\n    return () => {\n      window.removeEventListener('message', messageListener);\n    };\n  }\n\n  /**\n   *\n   * @param   postMessage Data to be sent to the Koji.\n   */\n  protected sendMessage(postMessage: PostMessage): void {\n    window.parent.postMessage(\n      {\n        _kojiEventName: postMessage.kojiEventName,\n        _type: postMessage.kojiEventName,\n        _feedKey: window.location.hash.replace('#koji-feed-key=', ''),\n        ...postMessage.data,\n      },\n      '*',\n    );\n  }\n\n  protected sendMessageAndAwaitResponse(postMessage: PostMessage, platformMessageName: string, additionalPlatformMessageName?: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const idempotencyKey = uuidv4();\n\n      const messageListener = ({ data }: { data: MessageListenerData }) => {\n        try {\n          const { event, _idempotencyKey } = data;\n          if ((event === platformMessageName || event === additionalPlatformMessageName) && idempotencyKey === _idempotencyKey) {\n            window.removeEventListener('message', messageListener);\n            resolve(data);\n          }\n        } catch (err) {\n          reject(err);\n        }\n      };\n\n      window.addEventListener('message', messageListener);\n\n      window.parent.postMessage(\n        {\n          _kojiEventName: postMessage.kojiEventName,\n          _type: postMessage.kojiEventName,\n          _feedKey: window.location.hash.replace('#koji-feed-key=', ''),\n          _idempotencyKey: idempotencyKey,\n          ...postMessage.data,\n        },\n        '*',\n      );\n    });\n  }\n}\n"],"file":"index.js"}