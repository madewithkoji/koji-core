{"version":3,"sources":["../../../src/frontend/kojiBridge/index.ts"],"names":["KojiBridge","callback","eventName","messageListener","data","event","window","addEventListener","removeEventListener","postMessage","parent","_kojiEventName","kojiEventName","_type","_feedKey","KOJI_FEED_KEY","platformMessageName","additionalPlatformMessageName","Promise","resolve","reject","idempotencyKey","_idempotencyKey","err","spreadableData","JSON","parse","stringify"],"mappings":";;;;;;;;;;;;;;;AACA;;;;;;AAeA;AACA;AACA;IACaA,U;;;;;;;;AACX;AACF;AACA;AACA;AACA;AACA;AACA;0CACkCC,Q,EAAoBC,S,EAAmB;AACrE,UAAMC,eAAe,GAAG,SAAlBA,eAAkB,OAA6C;AAAA,YAA1CC,IAA0C,QAA1CA,IAA0C;AAAA,YAC3DC,KAD2D,GACjDD,IADiD,CAC3DC,KAD2D;;AAEnE,YAAIA,KAAK,KAAKH,SAAd,EAAyB;AACvBD,UAAAA,QAAQ,CAACG,IAAD,CAAR;AACD;AACF,OALD;;AAOAE,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEA,aAAO,YAAM;AACXG,QAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACD,OAFD;AAGD;AAED;AACF;AACA;AACA;;;;gCACwBM,W,EAAgC;AACpDH,MAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,QAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,QAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,QAAAA,QAAQ,EAAER,MAAM,CAACS;AAJrB,SAKON,WAAW,CAACL,IALnB,GAOE,GAPF;AASD;;;gDAEqCK,W,EAA0BO,mB,EAA6BC,6B,EAAsD;AACjJ,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,YAAMC,cAAc,GAAG,eAAvB;;AAEA,YAAMlB,eAAe,GAAG,SAAlBA,eAAkB,QAA6C;AAAA,cAA1CC,IAA0C,SAA1CA,IAA0C;;AACnE,cAAI;AAAA,gBACMC,KADN,GACiCD,IADjC,CACMC,KADN;AAAA,gBACaiB,eADb,GACiClB,IADjC,CACakB,eADb;;AAEF,gBAAI,CAACjB,KAAK,KAAKW,mBAAV,IAAiCX,KAAK,KAAKY,6BAA5C,KAA8EI,cAAc,KAAKC,eAArG,EAAsH;AACpHhB,cAAAA,MAAM,CAACE,mBAAP,CAA2B,SAA3B,EAAsCL,eAAtC;AACAgB,cAAAA,OAAO,CAACf,IAAD,CAAP;AACD;AACF,WAND,CAME,OAAOmB,GAAP,EAAY;AACZH,YAAAA,MAAM,CAACG,GAAD,CAAN;AACD;AACF,SAVD;;AAYAjB,QAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmCJ,eAAnC;AAEAG,QAAAA,MAAM,CAACI,MAAP,CAAcD,WAAd;AAEIE,UAAAA,cAAc,EAAEF,WAAW,CAACG,aAFhC;AAGIC,UAAAA,KAAK,EAAEJ,WAAW,CAACG,aAHvB;AAIIE,UAAAA,QAAQ,EAAER,MAAM,CAACS,aAJrB;AAKIO,UAAAA,eAAe,EAAED;AALrB,WAMOZ,WAAW,CAACL,IANnB,GAQE,GARF;AAUD,OA3BM,CAAP;AA4BD;;;4CAEiCF,S,EAAmBD,Q,EAAiC;AACpFK,MAAAA,MAAM,CAACC,gBAAP,CAAwB,SAAxB,EAAmC,iBAA6C;AAAA,YAA1CH,IAA0C,SAA1CA,IAA0C;;AAC9E,YAAIA,IAAI,CAACC,KAAL,KAAeH,SAAnB,EAA8B;AAC5B,cAAMsB,cAAc,GAAGC,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,SAAL,CAAevB,IAAf,CAAX,CAAvB;AACAH,UAAAA,QAAQ,CAACuB,cAAD,CAAR;AACD;AACF,OALD;AAMD","sourcesContent":["/* eslint-disable @typescript-eslint/naming-convention */\nimport { v4 as uuidv4 } from 'uuid';\n\ninterface MessageListenerData {\n  /** Name of the event. */\n  event: string;\n  /** Unique key to prevent duplicate processing. */\n  _idempotencyKey?: string;\n}\n\ninterface PostMessage {\n  /** Name of the event. */\n  kojiEventName: string;\n  /** Data to send with event. */\n  data?: any;\n}\n/**\n * Enables communication between the platform and the Koji app.\n */\nexport class KojiBridge {\n  /**\n   * Sets a listener for a specific event, and invokes a function to handle the event.\n   *\n   * @param   callback  Function to run when the event is fired.\n   * @param   eventName Name of the event.\n   * @return            [description]\n   */\n  protected execCallbackOnMessage(callback: Function, eventName: string) {\n    const messageListener = ({ data }: { data: MessageListenerData }) => {\n      const { event } = data;\n      if (event === eventName) {\n        callback(data);\n      }\n    };\n\n    window.addEventListener('message', messageListener);\n\n    return () => {\n      window.removeEventListener('message', messageListener);\n    };\n  }\n\n  /**\n   *\n   * @param   postMessage Data to be sent to the Koji app.\n   */\n  protected sendMessage(postMessage: PostMessage): void {\n    window.parent.postMessage(\n      {\n        _kojiEventName: postMessage.kojiEventName,\n        _type: postMessage.kojiEventName,\n        _feedKey: window.KOJI_FEED_KEY,\n        ...postMessage.data,\n      },\n      '*',\n    );\n  }\n\n  protected sendMessageAndAwaitResponse(postMessage: PostMessage, platformMessageName: string, additionalPlatformMessageName?: string): Promise<any> {\n    return new Promise((resolve, reject) => {\n      const idempotencyKey = uuidv4();\n\n      const messageListener = ({ data }: { data: MessageListenerData }) => {\n        try {\n          const { event, _idempotencyKey } = data;\n          if ((event === platformMessageName || event === additionalPlatformMessageName) && idempotencyKey === _idempotencyKey) {\n            window.removeEventListener('message', messageListener);\n            resolve(data);\n          }\n        } catch (err) {\n          reject(err);\n        }\n      };\n\n      window.addEventListener('message', messageListener);\n\n      window.parent.postMessage(\n        {\n          _kojiEventName: postMessage.kojiEventName,\n          _type: postMessage.kojiEventName,\n          _feedKey: window.KOJI_FEED_KEY,\n          _idempotencyKey: idempotencyKey,\n          ...postMessage.data,\n        },\n        '*',\n      );\n    });\n  }\n\n  protected registerMessageListener(eventName: string, callback: (result: any) => void) {\n    window.addEventListener('message', ({ data }: { data: MessageListenerData }) => {\n      if (data.event === eventName) {\n        const spreadableData = JSON.parse(JSON.stringify(data));\n        callback(spreadableData);\n      }\n    });\n  }\n}\n"],"file":"index.js"}