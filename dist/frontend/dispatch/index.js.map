{"version":3,"sources":["../../../src/frontend/dispatch/index.ts"],"names":["unsafeGlobal","global","WebSocket","require","PlatformEvents","Dispatch","axios","get","projectId","data","config","Promise","resolve","ws","options","shardName","maxConnectionsPerShard","params","Object","keys","reduce","acc","cur","push","encodeURIComponent","url","join","authToken","authorization","Sockette","timeout","maxAttempts","onmessage","e","handleMessage","onreconnect","handleReconnect","onmaximum","handleMaximum","onclose","handleClose","onerror","handleError","JSON","parse","eventName","latencyMs","payload","CONNECTED","initialConnection","isConnected","identify","clientId","eventHandlers","forEach","handler","callback","console","log","messageQueue","send","error","handlerId","id","filter","mapConnectedClients","connectedClientsObj","map","key","CONNECTED_CLIENTS_CHANGED","connectedClients","userInfo","emitEvent","SET_USER_INFO","IDENTIFY","token","recipients","message","stringify","length","Error","close","dispatch"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;;;AAEA,IAAMA,YAAiB,GAAGC,MAA1B;AACAD,YAAY,CAACE,SAAb,GAAyBC,OAAO,CAAC,eAAD,CAAhC;AAEA;AACA;AACA;;AAqBA;AACA;AACA;IACYC,c;AAOZ;AACA;AACA;;;;WATYA,c;AAAAA,EAAAA,c;AAAAA,EAAAA,c;AAAAA,EAAAA,c;AAAAA,EAAAA,c;GAAAA,c,8BAAAA,c;;AA+DZ;AACA;AACA;IACaC,Q;;;;;gEAI0B,K;0DACN,K;4DACW,E;2DACT,E;iDACH,I;;;;;;AAE9B;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;uBAE2BC,kBAAMC,GAAN,qDAAuD,KAAKC,SAA5D,E;;;;AAAfC,gBAAAA,I,oBAAAA,I;iDACD,CAACA,IAAI,IAAI,EAAT,EAAa,CAAb,C;;;;;;;;;;;;;;;;AAGT;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;iCACsBD,S,EAAmB;AACrC,WAAKA,SAAL,GAAiBA,SAAjB;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;AAEuBE,gBAAAA,M,8DAAqC,E;kDACjD,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAa;AAC9B,sBAAI,KAAI,CAACC,EAAT,EAAa;AACX;AACD;;AAED,sBAAMC,OAAwB,GAAG;AAC/BN,oBAAAA,SAAS,EAAE,KAAI,CAACA,SADe;AAE/BO,oBAAAA,SAAS,EAAEL,MAAM,CAACK,SAFa;AAG/BC,oBAAAA,sBAAsB,EAAEN,MAAM,CAACM,sBAAP,IAAiC;AAH1B,mBAAjC;AAMA,sBAAMC,MAAgB,GAAGC,MAAM,CAACC,IAAP,CAAYL,OAAZ,EAAqBM,MAArB,CAA4B,UAACC,GAAD,EAAgBC,GAAhB,EAAwB;AAC3E,wBAAIR,OAAO,CAACQ,GAAD,CAAX,EAAkB;AAChBD,sBAAAA,GAAG,CAACE,IAAJ,WAAYD,GAAZ,cAAmBE,kBAAkB,CAACV,OAAO,CAACQ,GAAD,CAAR,CAArC;AACD;;AACD,2BAAOD,GAAP;AACD,mBALwB,EAKtB,EALsB,CAAzB;AAOA,sBAAMI,GAAG,2CAAoCR,MAAM,CAACS,IAAP,CAAY,GAAZ,CAApC,CAAT;AAEA,kBAAA,KAAI,CAACC,SAAL,GAAiBjB,MAAM,CAACkB,aAAxB,CApB8B,CAsB9B;;AACA,kBAAA,KAAI,CAACf,EAAL,GAAU,IAAIgB,oBAAJ,CAAaJ,GAAb,EAAkB;AAC1BK,oBAAAA,OAAO,EAAE,GADiB;AAE1BC,oBAAAA,WAAW,EAAE,EAFa;AAG1BC,oBAAAA,SAAS,EAAE,mBAACC,CAAD;AAAA,6BAAO,KAAI,CAACC,aAAL,CAAmBD,CAAnB,EAAsBrB,OAAtB,CAAP;AAAA,qBAHe;AAI1BuB,oBAAAA,WAAW,EAAE;AAAA,6BAAM,KAAI,CAACC,eAAL,EAAN;AAAA,qBAJa;AAK1BC,oBAAAA,SAAS,EAAE;AAAA,6BAAM,KAAI,CAACC,aAAL,EAAN;AAAA,qBALe;AAM1BC,oBAAAA,OAAO,EAAE,iBAACN,CAAD;AAAA,6BAAO,KAAI,CAACO,WAAL,CAAiBP,CAAjB,CAAP;AAAA,qBANiB;AAO1BQ,oBAAAA,OAAO,EAAE,iBAACR,CAAD;AAAA,6BAAO,KAAI,CAACS,WAAL,CAAiBT,CAAjB,CAAP;AAAA;AAPiB,mBAAlB,CAAV;AASD,iBAhCM,C;;;;;;;;;;;;;;;;AAmCT;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;wCACoDrB,O,EAAmB;AAAA,UAA7CH,IAA6C,QAA7CA,IAA6C;;AAAA,wBACzBkC,IAAI,CAACC,KAAL,CAAWnC,IAAI,IAAI,IAAnB,CADyB;AAAA,UAC3DoC,SAD2D,eAC3DA,SAD2D;AAAA,UAChDC,SADgD,eAChDA,SADgD;AAAA,UACrCC,OADqC,eACrCA,OADqC,EAGnE;AACA;AACA;;;AACA,UAAIF,SAAS,KAAKzC,cAAc,CAAC4C,SAAjC,EAA4C;AAC1C,aAAKC,iBAAL,GAAyB,IAAzB;AACA,aAAKC,WAAL,GAAmB,IAAnB;AACA,YAAI,KAAKvB,SAAT,EAAoB,KAAKwB,QAAL,CAAc,KAAKxB,SAAnB;AACpBf,QAAAA,OAAO,CAAC;AACNwC,UAAAA,QAAQ,EAAEL,OAAO,CAACK,QADZ;AAENrC,UAAAA,SAAS,EAAEgC,OAAO,CAAChC;AAFb,SAAD,CAAP;AAIA;AACD;;AAED,WAAKsC,aAAL,CAAmBC,OAAnB,CAA2B,UAACC,OAAD,EAAa;AACtC,YAAIV,SAAS,KAAKU,OAAO,CAACV,SAA1B,EAAqC;AACnCU,UAAAA,OAAO,CAACC,QAAR,CAAiBT,OAAjB,EAA0B;AAAED,YAAAA,SAAS,EAATA;AAAF,WAA1B;AACD;AACF,OAJD;AAKD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;sCAC4B;AAAA;;AACxBW,MAAAA,OAAO,CAACC,GAAR,CAAY,WAAZ;AACA,WAAKR,WAAL,GAAmB,IAAnB;AACA,WAAKS,YAAL,GAAoB,KAAKA,YAAL,CAAkBvC,MAAlB,CAAyB,UAACC,GAAD,EAAMC,GAAN,EAAc;AACzD,YAAI,MAAI,CAACT,EAAT,EAAa;AACX,UAAA,MAAI,CAACA,EAAL,CAAQ+C,IAAR,CAAatC,GAAb;AACD;;AACD,eAAOD,GAAP;AACD,OALmB,EAKjB,EALiB,CAApB;AAMD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;oCAC0B,CAAE;AAE1B;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;gCACsBY,C,EAAU;AAC5BwB,MAAAA,OAAO,CAACC,GAAR,CAAY,OAAZ,EAAqBzB,CAArB;AACA,WAAKiB,WAAL,GAAmB,KAAnB;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;gCACsBjB,C,EAAU;AAC5BwB,MAAAA,OAAO,CAACI,KAAR,CAAc,uBAAd,EAAuC5B,CAAvC;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;uBACYY,S,EAAmBW,Q,EAA4C;AAAA;;AACvE,UAAMM,SAAS,GAAG,eAAlB;AAEA,WAAKT,aAAL,CAAmB9B,IAAnB,CAAwB;AACtBwC,QAAAA,EAAE,EAAED,SADkB;AAEtBjB,QAAAA,SAAS,EAATA,SAFsB;AAGtBW,QAAAA,QAAQ,EAARA;AAHsB,OAAxB;AAMA,aAAO,YAAM;AACX,QAAA,MAAI,CAACH,aAAL,GAAqB,MAAI,CAACA,aAAL,CAAmBW,MAAnB,CAA0B;AAAA,cAAGD,EAAH,SAAGA,EAAH;AAAA,iBAAYA,EAAE,KAAKD,SAAnB;AAAA,SAA1B,CAArB;AACD,OAFD;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;8CACmCN,S,EAA4D;AAAA;;AAC3F,UAAMM,SAAS,GAAG,eAAlB,CAD2F,CAG3F;;AACA,eAASG,mBAAT,CAA6BC,mBAA7B,EAAuD;AACrD,eAAOhD,MAAM,CAACC,IAAP,CAAY+C,mBAAZ,EAAiCC,GAAjC,CAAqC,UAACC,GAAD;AAAA;AAC1ChB,YAAAA,QAAQ,EAAEgB;AADgC,aAEvC,CAACF,mBAAmB,CAACE,GAAD,CAApB,EAA2B,CAA3B,CAFuC;AAAA,SAArC,CAAP;AAID;;AAED,WAAKf,aAAL,CAAmB9B,IAAnB,CAAwB;AACtBwC,QAAAA,EAAE,EAAED,SADkB;AAEtBjB,QAAAA,SAAS,EAAEzC,cAAc,CAACiE,yBAFJ;AAGtBb,QAAAA,QAAQ,EAAE,kBAACT,OAAD;AAAA,iBAAkBS,SAAQ,CAACS,mBAAmB,CAAClB,OAAO,CAACuB,gBAAT,CAApB,CAA1B;AAAA;AAHY,OAAxB;AAMA,aAAO,YAAM;AACX,QAAA,MAAI,CAACjB,aAAL,GAAqB,MAAI,CAACA,aAAL,CAAmBW,MAAnB,CAA0B;AAAA,cAAGD,EAAH,SAAGA,EAAH;AAAA,iBAAYA,EAAE,KAAKD,SAAnB;AAAA,SAA1B,CAArB;AACD,OAFD;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;gCACqBS,Q,EAAoC;AACrD,WAAKC,SAAL,CAAepE,cAAc,CAACqE,aAA9B,EAA6CF,QAA7C;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;6BACkB5C,S,EAAmB;AACjC,WAAK6C,SAAL,CAAepE,cAAc,CAACsE,QAA9B,EAAwC;AACtCC,QAAAA,KAAK,EAAEhD;AAD+B,OAAxC;AAGD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;8BACmBkB,S,EAAmBE,O,EAAmC6B,U,EAAuB;AAC5F,UAAMC,OAAO,GAAGlC,IAAI,CAACmC,SAAL,CAAe;AAC7BjC,QAAAA,SAAS,EAATA,SAD6B;AAE7BE,QAAAA,OAAO,EAAPA,OAF6B;AAG7B6B,QAAAA,UAAU,EAAVA;AAH6B,OAAf,CAAhB,CAD4F,CAO5F;;AACA,UAAIC,OAAO,CAACE,MAAR,GAAiB,KAArB,EAA4B;AAC1B,cAAM,IAAIC,KAAJ,CAAU,wFAAV,CAAN;AACD,OAV2F,CAY5F;;;AACA,UAAI,CAAC,KAAK/B,iBAAN,IAA2B,CAAC,KAAKpC,EAArC,EAAyC;AACvC,cAAM,IAAImE,KAAJ,CAAU,8FAAV,CAAN;AACD,OAf2F,CAiB5F;;;AACA,UAAI,CAAC,KAAK9B,WAAV,EAAuB;AACrB,aAAKS,YAAL,CAAkBpC,IAAlB,CAAuBsD,OAAvB;AACA;AACD;;AAED,WAAKhE,EAAL,CAAQ+C,IAAR,CAAaiB,OAAb;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;AACA;;;;iCACsB;AAClB,UAAI,KAAKhE,EAAT,EAAa,KAAKA,EAAL,CAAQoE,KAAR;AACb,WAAKpE,EAAL,GAAU,IAAV;AACD;;;;;;AAGI,IAAMqE,QAAQ,GAAG,IAAI7E,QAAJ,EAAjB","sourcesContent":["import { v4 as uuidv4 } from 'uuid';\nimport Sockette from 'sockette';\nimport axios from 'axios';\n\nconst unsafeGlobal: any = global;\nunsafeGlobal.WebSocket = require('isomorphic-ws');\n\n/**\n * Configuration options for a new connection.\n */\nexport interface DispatchConfigurationInput {\n  /** Name of the dispatch shard to use. If not specified, the client is added to a shard automatically. */\n  shardName?: string | null;\n  /** Total clients to allow on a shard before it is full (defaults to 100). When a shard is full, new clients are added to a new shard unless a different shard is explicitly set. */\n  maxConnectionsPerShard?: number;\n  /** Short-lived user token that identifies the client, so the server and other connected clients can send it secure messages. If this value is not included, you can [[identify | identify the client]] after it is connected. */\n  authorization?: string;\n}\n\n/**\n * Defines a DispatchOptions interface.\n */\nexport interface DispatchOptions {\n  projectId?: string;\n  shardName?: string | null;\n  maxConnectionsPerShard?: number;\n  authorization?: string;\n  [index: string]: any;\n}\n\n/**\n * Defines constants for Koji platform events.\n */\nexport enum PlatformEvents {\n  CONNECTED = '@@KOJI_DISPATCH/CONNECTED',\n  CONNECTED_CLIENTS_CHANGED = '@@KOJI_DISPATCH/CONNECTED_CLIENTS_CHANGED',\n  IDENTIFY = '@@KOJI_DISPATCH/IDENTIFY',\n  SET_USER_INFO = '@@KOJI_DISPATCH/SET_USER_INFO',\n}\n\n/**\n * Defines a MessageHandler interface.\n */\nexport interface MessageHandler {\n  id: string;\n  eventName: string;\n  callback: MessageHandlerCallback | ConnectedClientsChangedHandlerCallback;\n}\n\n/**\n * Information about a client that is connected to a shard.\n */\nexport interface ConnectedClient {\n  /** Unique identifier for the client. */\n  clientId: string;\n  /** Timestamp of the client's most recent ping (network activity). */\n  lastPing: number;\n}\n\nexport type ConnectedClientsChangedHandlerCallback =\n/**\n * Function to handle a dispatch event for a new or updated client connection. Invoked by the [[onConnectedClientsChanged]] listener.\n *\n * @param connectedClients   Array of information about the connected clients in the shard.\n */\n(connectedClients: ConnectedClient[]) => void;\n\nexport type MessageHandlerCallback =\n/**\n * Function to handle a dispatch event. Invoked by the [[on]] listener.\n *\n * @param payload   Data payload sent with the fired event.\n * @param metadata  Object containing additional information about the event, including the message latency in milliseconds.\n */\n(payload: { [index: string]: any }, metadata: { latencyMs?: number }) => void;\n\n/**\n * Information about a dispatch shard.\n */\nexport interface ShardInfo {\n  /** Name of the dispatch shard. */\n  shardName: string;\n  /** Number of clients currently connected to the dispatch shard. */\n  numConnectedClients: number;\n}\n\n/**\n * Connection details for a client. Returned when the client [[connect | connects to a dispatch shard]].\n */\nexport interface ConnectionInfo {\n  /** ID of the connected client. */\n  clientId?: string;\n  /** Name of the dispatch shard that the client is connected to. */\n  shardName: string;\n}\n\n/**\n * Implements a dispatch system for real-time communication on the frontend of your Koji app.\n */\nexport class Dispatch {\n  private authToken?: string;\n  private projectId?: string;\n\n  private initialConnection: boolean = false;\n  private isConnected: boolean = false;\n  private eventHandlers: MessageHandler[] = [];\n  private messageQueue: string[] = [];\n  private ws: Sockette | null = null;\n\n  /**\n   * Gets information about the active dispatch shards.\n   *\n   * @return    Array of objects containing information about the dispatch shards.\n   *\n   * @example\n   * ```javascript\n   * const shardInfo = await Koji.dispatch.info();\n   * ```\n   */\n  public async info(): Promise<ShardInfo> {\n    const { data } = await axios.get(`https://dispatch-info.api.gokoji.com/info/${this.projectId}`);\n    return (data || [])[0];\n  }\n\n  /**\n   * Sets the project ID for the dispatch service.\n   *\n   * @param     projectId     Unique identifier for the Koji project.\n   *\n   * @example\n   * ```javascript\n   * Koji.dispatch.setProjectId(myProject);\n   * ```\n   */\n  public setProjectId(projectId: string) {\n    this.projectId = projectId;\n  }\n\n  /**\n   * Connects a client to a dispatch shard.\n   *\n   * @param     config    Configuration options for the connection.\n   *\n   * @return              Connection details, including the client ID and shard name.\n\n   *\n   * @example\n   * ```javascript\n   * const myInfo = await Koji.dispatch.connect({\n   *  maxConnectionsPerShard: '25',\n   *  authorization: token\n   * });\n   * ```\n   */\n  public async connect(config: DispatchConfigurationInput = {}): Promise<ConnectionInfo> {\n    return new Promise((resolve) => {\n      if (this.ws) {\n        return;\n      }\n\n      const options: DispatchOptions = {\n        projectId: this.projectId,\n        shardName: config.shardName,\n        maxConnectionsPerShard: config.maxConnectionsPerShard || 100,\n      };\n\n      const params: string[] = Object.keys(options).reduce((acc: string[], cur) => {\n        if (options[cur]) {\n          acc.push(`${cur}=${encodeURIComponent(options[cur])}`);\n        }\n        return acc;\n      }, []);\n\n      const url = `wss://dispatch.api.gokoji.com?${params.join('&')}`;\n\n      this.authToken = config.authorization;\n\n      // Create a socket connection to the dispatch server\n      this.ws = new Sockette(url, {\n        timeout: 5e3,\n        maxAttempts: 10,\n        onmessage: (e) => this.handleMessage(e, resolve),\n        onreconnect: () => this.handleReconnect(),\n        onmaximum: () => this.handleMaximum(),\n        onclose: (e) => this.handleClose(e),\n        onerror: (e) => this.handleError(e),\n      });\n    });\n  }\n\n  /**\n   * Handles a message event.\n   *\n   * @param     data        JSON object containing eventName, latencyMS, and payload.\n   * @param     eventName   PlatformEvents enum value\n   * @param     latencyMS   Latency in milliseconds\n   * @param     payload     Client object\n   *\n   * @example\n   * ```javascript\n   * dispatch.handleMessage(PlatformEvents.CONNECTED, 1000, client);\n   * ```\n   */\n  private handleMessage({ data }: { data: string }, resolve: Function) {\n    const { eventName, latencyMs, payload } = JSON.parse(data || '{}');\n\n    // On an explicit connection event, we update the local state\n    // and short-circuit to prevent it from passing to registered\n    // event handlers.\n    if (eventName === PlatformEvents.CONNECTED) {\n      this.initialConnection = true;\n      this.isConnected = true;\n      if (this.authToken) this.identify(this.authToken);\n      resolve({\n        clientId: payload.clientId,\n        shardName: payload.shardName,\n      });\n      return;\n    }\n\n    this.eventHandlers.forEach((handler) => {\n      if (eventName === handler.eventName) {\n        handler.callback(payload, { latencyMs });\n      }\n    });\n  }\n\n  /**\n   * Reconnects a shard.\n   *\n   * @example\n   * ```javascript\n   * dispatch.handleReconnect();\n   * ```\n   */\n  private handleReconnect() {\n    console.log('reconnect');\n    this.isConnected = true;\n    this.messageQueue = this.messageQueue.reduce((acc, cur) => {\n      if (this.ws) {\n        this.ws.send(cur);\n      }\n      return acc;\n    }, []);\n  }\n\n  /**\n   * Handles maximum.\n   *\n   * @example\n   * ```javascript\n   * dispatch.handleMaximum();\n   * ```\n   */\n  private handleMaximum() {}\n\n  /**\n   * Cleans up when connection is closed.\n   *\n   * @example\n   * ```javascript\n   * dispatch.handleClose();\n   * ```\n   */\n  private handleClose(e: Event) {\n    console.log('close', e);\n    this.isConnected = false;\n  }\n\n  /**\n   * Prints error message to console.\n   *\n   * @param     e    Event that generated the error.\n   *\n   * @example\n   * ```javascript\n   * dispatch.handleError(e);\n   * ```\n   */\n  private handleError(e: Event) {\n    console.error('[Koji Dispatch] error', e);\n  }\n\n  /**\n   * Sets a listener for a specific event, and invokes a callback function when the event is dispatched over the shard.\n   *\n   * @param     eventName     Name of the event to subscribe to.\n   * @param     callback      Function to invoke when the event is fired.\n   *\n   * @return                  Function to unsubscribe from the event listener.\n   *\n   * @example\n   * ```javascript\n   * unsubscribeEvent = Koji.dispatch.on('eventName', callbackFunction);\n   * ```\n   */\n  public on(eventName: string, callback: MessageHandlerCallback): Function {\n    const handlerId = uuidv4();\n\n    this.eventHandlers.push({\n      id: handlerId,\n      eventName,\n      callback,\n    });\n\n    return () => {\n      this.eventHandlers = this.eventHandlers.filter(({ id }) => id !== handlerId);\n    };\n  }\n\n  /**\n   * Sets a listener for changes to connected clients, and invokes a callback function when the event is dispatched over the shard.\n   * A change occurs whenever any client connects, disconnects, or updates their user information with [[setUserInfo]].\n   *\n   * @param     callback      Function to invoke when the event is fired.\n   *\n   * @return                  Function to unsubscribe from the event listener.\n   *\n   * @example\n   * ```javascript\n   * unsubscribeEvent = Koji.dispatch.onConnectedClientsChanged(callbackFunction);\n   * ```\n   */\n  public onConnectedClientsChanged(callback: ConnectedClientsChangedHandlerCallback): Function {\n    const handlerId = uuidv4();\n\n    // Map the object of connected clients to an array, keyed by clientId\n    function mapConnectedClients(connectedClientsObj: any) {\n      return Object.keys(connectedClientsObj).map((key) => ({\n        clientId: key,\n        ...[connectedClientsObj[key]][0],\n      }));\n    }\n\n    this.eventHandlers.push({\n      id: handlerId,\n      eventName: PlatformEvents.CONNECTED_CLIENTS_CHANGED,\n      callback: (payload: any) => callback(mapConnectedClients(payload.connectedClients)),\n    });\n\n    return () => {\n      this.eventHandlers = this.eventHandlers.filter(({ id }) => id !== handlerId);\n    };\n  }\n\n  /**\n   * Sets user information that is available in the [[onConnectedClientsChanged]] listener.\n   *\n   * @param     userInfo      Data to set for the client's user information.\n   *\n   * @example\n   * ```javascript\n   * Koji.dispatch.setUserInfo({ avatar: userAvatar });\n   * ```\n   */\n  public setUserInfo(userInfo: { [index: string]: any }) {\n    this.emitEvent(PlatformEvents.SET_USER_INFO, userInfo);\n  }\n\n  /**\n   * Identifies a connected client, which enables the server and other connected clients to send it secure messages.\n   *\n   * @param     authToken     Short-lived user token for the connected client. To get a user token, use {@doclink core-frontend-identity#getToken | Identity.getToken}.\n   *\n   * @example\n   * ```javascript\n   * const { userToken, presumedRole, presumedAttributes  } = await Koji.identity.getToken();\n   * Koji.dispatch.identify(userToken);\n   * ```\n   */\n  public identify(authToken: string) {\n    this.emitEvent(PlatformEvents.IDENTIFY, {\n      token: authToken,\n    });\n  }\n\n  /**\n   * Emits the named event to the specified recipients or to all clients.\n   *\n   * @param     eventName     Name of the event.\n   * @param     payload       Object of key-value pair data to send as a message payload.\n   * @param     recipients    List of clients to receive the event. If this parameter is not included, the event is sent to all clients on the current shard.\n   *\n   * @example\n   * ```javascript\n   * Koji.dispatch.emitEvent('myEvent', myDataPayload);\n   * ```\n   */\n  public emitEvent(eventName: string, payload: { [index: string]: any }, recipients?: string[]) {\n    const message = JSON.stringify({\n      eventName,\n      payload,\n      recipients,\n    });\n\n    // Discard a long message\n    if (message.length > 128e3) {\n      throw new Error('Message is too long to be sent through Koji Dispatch. Messages must be less than 128kb');\n    }\n\n    // Check instantiation\n    if (!this.initialConnection || !this.ws) {\n      throw new Error('Please make sure you have called and awaited `connect()` before attempting to send a message');\n    }\n\n    // If the connection has dropped, push the message into a queue\n    if (!this.isConnected) {\n      this.messageQueue.push(message);\n      return;\n    }\n\n    this.ws.send(message);\n  }\n\n  /**\n   * Disconnects the client from the dispatch shard.\n   *\n   * @example\n   * ```javascript\n   * Koji.dispatch.disconnect();\n   * ```\n   */\n  public disconnect() {\n    if (this.ws) this.ws.close();\n    this.ws = null;\n  }\n}\n\nexport const dispatch = new Dispatch();\n"],"file":"index.js"}